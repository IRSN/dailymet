<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="dailymet">
<title>R Package `dailymet`: Overview • dailymet</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="R Package `dailymet`: Overview">
<meta property="og:description" content="dailymet">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">dailymet</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.7</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/Intro.html">R Package `dailymet`: Overview</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">



<script src="Intro_files/htmlwidgets-1.6.4/htmlwidgets.js"></script><link href="Intro_files/leaflet-1.3.1/leaflet.css" rel="stylesheet">
<script src="Intro_files/leaflet-1.3.1/leaflet.js"></script><link href="Intro_files/leafletfix-1.0.0/leafletfix.css" rel="stylesheet">
<script src="Intro_files/proj4-2.6.2/proj4.min.js"></script><script src="Intro_files/Proj4Leaflet-1.0.1/proj4leaflet.js"></script><link href="Intro_files/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet">
<script src="Intro_files/leaflet-binding-2.2.1/leaflet.js"></script><div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>R Package `dailymet`: Overview</h1>
                        <h4 data-toc-skip class="author">Yves Deville <a href="deville.yves@alpestat.com">deville.yves@alpestat.com</a>
</h4>
            
            <h4 data-toc-skip class="date">2023-12-28</h4>
      
      
      <div class="d-none name"><code>Intro.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="goals">Goals<a class="anchor" aria-label="anchor" href="#goals"></a>
</h2>
<ul>
<li><p>Use daily meteorological timeseries, mainly
<code>TX</code>.</p></li>
<li><p>Provide bases of functions of the date: trigonometric,
polynomial, …</p></li>
<li><p>Fit time-varying and non-stationary <em>POT models</em> with
emphasis on the sensitivity to the <em>threshold choice</em>, thanks to
dedicated classes of objects that we may call “TLists” for <em>list by
threshold</em>.</p></li>
</ul>
</div>
<div class="section level2">
<h2 id="data-classes-and-data-manipulation-functions">Data classes and data manipulation functions<a class="anchor" aria-label="anchor" href="#data-classes-and-data-manipulation-functions"></a>
</h2>
<div class="section level3">
<h3 id="the-dailymet-data-class">The <code>"dailyMet"</code> data class<a class="anchor" aria-label="anchor" href="#the-dailymet-data-class"></a>
</h3>
<p>As its name may suggest the <code>"dailyMet"</code> S3 class contains
objects describing meteorological timeseries sampled on a daily basis.
The package comes with the <code>Rennes</code> example.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://irsn.github.io/dailymet/">dailymet</a></span><span class="op">)</span></span>
<span><span class="va">Rennes</span></span></code></pre></div>
<pre><code><span><span class="co">## o Daily Meteorological Time Series</span></span>
<span><span class="co">##    o Station:            "Rennes-Saint-Jacques"</span></span>
<span><span class="co">##    o Id:                 "07130"</span></span>
<span><span class="co">##    o Variable name:      "TX"</span></span>
<span><span class="co">##    o Period length (yrs)  77.66</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##    o Non-missing periods</span></span>
<span><span class="co">##        Start        End Duration</span></span>
<span><span class="co">## 1 1945-01-02 2022-08-31    77.66</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##    o Summary for variable  TX </span></span>
<span><span class="co">##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span><span class="co">##   -7.50   11.30   15.90   16.18   21.10   40.50 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">##    o Five smallest/largest obs</span></span>
<span><span class="co">##      min                 max                </span></span>
<span><span class="co">## [1,]   -7.5 [1987-01-12]   40.5 [2022-07-18]</span></span>
<span><span class="co">## [2,]   -7.0 [1963-01-19]   40.1 [2019-07-23]</span></span>
<span><span class="co">## [3,]   -6.6 [1985-01-16]   39.5 [2003-08-05]</span></span>
<span><span class="co">## [4,]   -6.3 [1987-01-13]   38.8 [2003-08-09]</span></span>
<span><span class="co">## [5,]   -5.9 [1987-01-18]   38.4 [1949-07-12]</span></span></code></pre>
<p>The <code>print</code> method used for <code>Rennes</code> shows the
summary above which provides the essential information.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">Rennes</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "dailyMet"   "data.frame"</span></span></code></pre>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/methods.html" class="external-link">methods</a></span><span class="op">(</span>class <span class="op">=</span> <span class="st">"dailyMet"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] autoplot head     print    subset   summary  tail    </span></span>
<span><span class="co">## see '?methods' for accessing help and source code</span></span></code></pre>
<p>So <code>Rennes</code> has class <code>"dailyMet"</code> which
inherits from the <code>"data.frame"</code>class. The <code>print</code>
method provides useful information. A method which is not implemented
for the class <code>"dailyMet"</code> will be inherited from the
<code>"data.frame"</code> class e.g., <code>head</code>,
<code>tail</code>, <code>nrow</code> …</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span><span class="va">Rennes</span><span class="op">)</span></span></code></pre></div>
<p><img src="Intro_files/figure-html/Rennes2-1.png" width="768"></p>
<p>Since the object embeds several variables related to the date, we can
use these straightforwardly. Mind that the variable names are
capitalised.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span><span class="va">Rennes</span>, subset <span class="op">=</span> <span class="va">Year</span> <span class="op">&gt;=</span> <span class="fl">2010</span> <span class="op">&amp;</span> <span class="va">JJA</span>, group <span class="op">=</span> <span class="st">"year"</span><span class="op">)</span></span></code></pre></div>
<p><img src="Intro_files/figure-html/Rennes3-1.png" width="768"></p>
<p>Splitting the timeseries in years is suitable when the interest is on
the summer season. It the interest is instead on winter, then using the
“winter year” <code>YearW</code> will be better since the whole winter
is included in a same “year”.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span><span class="va">Rennes</span>, subset <span class="op">=</span> <span class="va">Year</span> <span class="op">&gt;=</span> <span class="fl">2010</span>, group <span class="op">=</span> <span class="st">"yearW"</span><span class="op">)</span></span></code></pre></div>
<p><img src="Intro_files/figure-html/Rennes4-1.png" width="768"></p>
</div>
<div class="section level3">
<h3 id="creating-dailymet-objects-from-data-files">Creating <code>dailyMet</code> objects from data files<a class="anchor" aria-label="anchor" href="#creating-dailymet-objects-from-data-files"></a>
</h3>
<p>Although no other data is shipped with the package,
<strong>dailymet</strong> has a sketch of file-based database, based on
the information provided in <code>stationsMF</code></p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/findStationMF.html">findStationMF</a></span><span class="op">(</span><span class="st">"troy"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##              Desc    Id            Name      Lat  Lon Alt                   Dir</span></span>
<span><span class="co">## 1 troyes-barberey 07168 TROYES-BARBEREY 48.32467 4.02 112 07168_troyes-barberey</span></span></code></pre>
<p>The idea is that the name or description can be quite loose. The
reliable identifier of a station is given in <code>Code</code>, which
corresponds to Météo-France <a href="https://donneespubliques.meteofrance.fr/" class="external-link">données publiques
Météo-France</a></p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">stationsMF</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##      Id            Name      Lat       Lon Alt           LongName ShortName</span></span>
<span><span class="co">## 1 07005       ABBEVILLE 50.13600  1.834000  69          Abbeville     Abbev</span></span>
<span><span class="co">## 2 07015   LILLE-LESQUIN 50.57000  3.097500  47      Lille-Lesquin     Lille</span></span>
<span><span class="co">## 3 07020 PTE DE LA HAGUE 49.72517 -1.939833   6 Pointe de la Hague  La-Hague</span></span>
<span><span class="co">## 4 07027  CAEN-CARPIQUET 49.18000 -0.456167  67     Caen-Carpiquet      Caen</span></span>
<span><span class="co">## 5 07037      ROUEN-BOOS 49.38300  1.181667 151         Rouen-Boos     Rouen</span></span>
<span><span class="co">## 6 07072    REIMS-PRUNAY 49.20967  4.155333  95       Reims-Prunay     Reims</span></span>
<span><span class="co">##             Zone            Desc OldCode Resol40 Clim</span></span>
<span><span class="co">## 1          Somme       abbeville   abbev       1   NW</span></span>
<span><span class="co">## 2           Nord   lille-lesquin               1    C</span></span>
<span><span class="co">## 3         Manche cap-de-la-hague               1   NW</span></span>
<span><span class="co">## 4       Calvados  caen-carpiquet    caen       1   NW</span></span>
<span><span class="co">## 5 Seine-Maritime      rouen-boos   rouen       1    C</span></span>
<span><span class="co">## 6          Marne    reims-prunay   reims       1    C</span></span></code></pre>
<p>We will focus on the French metropolitan area.</p>
<div class="leaflet html-widget html-fill-item" id="htmlwidget-d402cb03a1d5f1d02a37" style="width:576px;height:576px;"></div>
<script type="application/json" data-for="htmlwidget-d402cb03a1d5f1d02a37">{"x":{"options":{"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}}},"calls":[{"method":"addTiles","args":["https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",null,null,{"minZoom":0,"maxZoom":18,"tileSize":256,"subdomains":"abc","errorTileUrl":"","tms":false,"noWrap":false,"zoomOffset":0,"zoomReverse":false,"opacity":1,"zIndex":1,"detectRetina":false,"attribution":"&copy; <a href=\"https://openstreetmap.org/copyright/\">OpenStreetMap<\/a>,  <a href=\"https://opendatacommons.org/licenses/odbl/\">ODbL<\/a>"}]},{"method":"addMarkers","args":[[50.136,50.57,49.725167,49.18,49.383,49.209667,48.444167,48.825833,48.068833,48.4455,48.716833,48.324667,48.581,48.5495,47.294333,47.15,47.4445,47.059167,47.267833,47.614333,46.046833,46.593833,45.861167,45.786833,45.0745,45.7265,44.830667,44.745,44.1185,44.581167,44.565667,43.909833,43.188,43.005333,43.621,43.577,43.437667,43.079333,43.648833,42.737167,41.918,42.540667,-11.582667,-17.054667,-22.344167,-15.887667,-20.8925,-37.795167,-46.4325,-49.352333,-12.8055,46.766333,16.335,17.9015,16.264,14.7745,14.595333,5.4855,4.822333,3.890667,3.640167,-66.663167,44.17222,47.47889,49.44639,47.24889,43.46944,50.7325,48.6,45.612778,49.65278,45.35667,46.17806,48.96722,47.94667,48.82333,46.99833,43.85694,43.381,45.53306,48.63139,49.06944,43.305],[1.834,3.0975,-1.939833,-0.456167,1.181667,4.155333,-4.412,-3.473167,-1.734,0.110167,2.384333,4.02,5.959833,7.640333,-3.218333,-1.608833,0.727333,2.359833,5.088333,7.51,-1.4115,0.314333,1.175,3.149333,3.764,5.077833,-0.691333,1.396667,3.0195,4.733,6.502333,-0.500167,0,1.106833,1.378833,3.963167,5.216,5.940833,7.209,2.872833,8.792667,9.485167000000001,47.289667,42.712,40.340667,54.520667,55.528667,77.56916699999999,51.856667,70.24333300000001,45.282833,-56.179167,-61.004,-62.852167,-61.516333,-60.875333,-60.995667,-54.031667,-52.365333,-51.804667,-54.028333,140.001,0.5947222,-0.614444,2.127222,5.988889,-1.53444,1.599722,2.326667,6.763333,-1.463611,5.325,-1.193056,2.427778,0.195,2.336667,3.112778,4.406389,-0.4164,4.291667,4.903611,6.125556,5.3966667],null,null,null,{"interactive":true,"draggable":false,"keyboard":true,"title":"","alt":"","zIndexOffset":0,"opacity":1,"riseOnHover":false,"riseOffset":250},["Abbev","Lille","La-Hague","Caen","Rouen","Reims","Brest","Ploumanach","Rennes","Alencon","Orly","Troyes","Nancy","Strasbourg","Belle-Ile","Nantes","Tours","Bourges","Dijon","Bale","Pte-Chassiron","Poitiers","Limoges","Clermont-Fd","Le-Puy","Lyon","Bordeaux","Gourdon","Millau","Montelimar","Embrun","Mt-Marsan","Tarbes","St-Girons","Toulouse","Montpellier","Marignane","Cap-Cepet","Nice","Perpignan","Ajaccio","Bastia","Glorieuses","Juan-de-Nova","Europa","Tromelin","Gillot","Nvelle-Amsterdam","Crozet","Kerguelen","Pamandzi","St-Pierre","Desirade","St-Barthelemy","Le-Raizet","Trinite","Lamentin","St-Laurent","Cayenne","St-Georges","Maripasoula","Dumont-Urville","Agen","Angers","Beauvais","Besancon","Biarritz","Boulogne-s-Mer","Bretigny","Bourg-St-Maurice","Cherbourg","Grenoble","La-Rochelle","Le-Bourget","Le-Mans","Montsouris","Nevers","Nîmes","Pau","St-Etienne","St-Dizier","Metz","Marseille-Longchamp"],null,null,null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]}],"setView":[[47.1,2],5,[]],"limits":{"lat":[-66.663167,50.7325],"lng":[-62.852167,140.001]}},"evals":[],"jsHooks":[]}</script><p>See the help <code>stationsMF</code> for a <strong>leaflet</strong>
map of these. Note that the codes of the main MF stations for the
metropolitan area correspond roughly to an ordering from North to South
(decreasing latitude) and West to East (increasing longitude). This can
be of some help.</p>
<p>Provided that the data is available in <code>.csv</code> files
suitably named, we can read these into <code>dailyMet</code> objects.
The function <code>readMet</code> can be used for that aim. In order to
avoid a tedious construction of filenames an automated naming is used.
For instance the full information for MF station <em>Troyes</em>
(actually at the <em>Troyes-Barberey</em> airport) is found in the list
returned by <code>findStationMF</code>. This list can be passed as the
first argument of the <code>readMet</code> function, which will build
the filename from the values of the <code>Id</code> and
<code>Name</code> fields. The file is to be found in a directory with
its name stored in the environment variable <code>metData</code>.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## fails: several stations match</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/try.html" class="external-link">try</a></span><span class="op">(</span><span class="fu"><a href="../reference/findStationMF.html">findStationMF</a></span><span class="op">(</span><span class="st">"tro"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Several matches found:</span></span>
<span><span class="co">## 1 troyes-barberey 07168</span></span>
<span><span class="co">## 2 serge-frolow-ile-tromelin 61976</span></span>
<span><span class="co">## Error in findStationMF("tro") : several stations match. Hint. use 'id ='</span></span></code></pre>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">myStation</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/findStationMF.html">findStationMF</a></span><span class="op">(</span><span class="st">"troyes"</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/try.html" class="external-link">try</a></span><span class="op">(</span><span class="fu"><a href="../reference/readMet.html">readMet</a></span><span class="op">(</span><span class="va">myStation</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Error in readMet(myStation) : </span></span>
<span><span class="co">##   The `metData` environment variable is not set. Use `Sys.setenv(metData = x)` to set it.</span></span></code></pre>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Sys.setenv.html" class="external-link">Sys.setenv</a></span><span class="op">(</span>metData <span class="op">=</span> <span class="st">"~/Bureau/climatoData"</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/try.html" class="external-link">try</a></span><span class="op">(</span><span class="va">Troyes</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/readMet.html">readMet</a></span><span class="op">(</span><span class="va">myStation</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Error in readMet(myStation) : </span></span>
<span><span class="co">##   The `metData` environment variable does not define an existing directory.</span></span></code></pre>
<p>Although the file is not found, we now see the name of the file that
is sought for.</p>
</div>
</div>
<div class="section level2">
<h2 id="functions-and-classes-for-analyses-and-models">Functions and classes for analyses and models<a class="anchor" aria-label="anchor" href="#functions-and-classes-for-analyses-and-models"></a>
</h2>
<div class="section level3">
<h3 id="peaks-over-threshold-pot-models">Peaks Over Threshold (POT) models<a class="anchor" aria-label="anchor" href="#peaks-over-threshold-pot-models"></a>
</h3>
<p>The package focusses on so-called <em>Poisson-GP</em> POT models for
random observations <span class="math inline">\(y(t)\)</span> where
<span class="math inline">\(t\)</span> denotes a continuous time index.
The model involves a <em>time-varying threshold</em> <span class="math inline">\(u(t)\)</span> and a <em>time-varying Generalized
Pareto distribution</em> for the excess <span class="math inline">\(y(t)
- u(t)\)</span> as recorded at an exceedance time <span class="math inline">\(y(t) &gt; u(t)\)</span>. The exceedance times are
assumed to occur according to a Non-Homogeneous Poisson Process (NHPPP)
with rate <span class="math inline">\(\lambda(t)\)</span>. The excesses
<span class="math inline">\(y(t) - u(t)\)</span> at the exceedances are
asumed to follow the two-parameter Generalised Pareto (GP) distribution
with scale <span class="math inline">\(\sigma(t)&gt;0\)</span> and shape
<span class="math inline">\(\xi(t)\)</span>. This distribution has
support <span class="math inline">\((0, \,\infty)\)</span> and the value
of the survival function is given for <span class="math inline">\(x
&gt;0\)</span> by <span class="math display">\[
   S_{\texttt{GP2}}(x;\,\sigma,\,\xi) =
   \begin{cases}
   \left[1 + \xi \, x/\sigma \right]_+^{-1/\xi} &amp; \xi \neq 0\\
   \exp\{- x/ \sigma \} &amp; \xi = 0
   \end{cases}
\]</span> where <span class="math inline">\(z_+:= \max\{z,\,
0\}\)</span> denotes the positive part or a real number <span class="math inline">\(z\)</span>.</p>
<p>In practice, we will consider <em>daily</em> discrete-time timeseries
<span class="math inline">\(y_t\)</span> where <span class="math inline">\(t\)</span> denotes the day i.e., the date.
Similarly, the threshold <span class="math inline">\(u_t\)</span>, the
rate <span class="math inline">\(\lambda_t\)</span> and the GP
parameters <span class="math inline">\(\sigma_t\)</span> and <span class="math inline">\(\xi_t\)</span> will be daily non random)
timeseries. Provided that the exceedance rate is small enough, a
discrete-time framework can be deduced from the continuous-time one.
This model can also be related as well to the Binomial-GP model where
the daily exceedance probabillity is small enough.</p>
</div>
<div class="section level3">
<h3 id="using-tlists">Using <em>TList</em>s<a class="anchor" aria-label="anchor" href="#using-tlists"></a>
</h3>
<div class="section level4">
<h4 id="what-are-tlists">What are TLists?<a class="anchor" aria-label="anchor" href="#what-are-tlists"></a>
</h4>
<p>A T-list or is a list of objects sharing the same definition except
for their threshold. The threshold is related to a probability
<code>tau</code> corresponding to the probability <span class="math inline">\(\tau\)</span> as used in quantile regression.</p>
<ul>
<li><p>A <code>rqTList</code> object is a list of <code>rq</code>
objects differing only by their probability <code>tau</code>, hence
related to the same data, same formula, …</p></li>
<li><p>A <code>fevdTList</code> object is a list of <code>fevd</code>
objects representing Poisson-GP POT models differing <em>only by their
threshold</em> which is given by quantile regression and corresponds to
different probabilities <code>tau</code>. Again the
<code>fevd</code>objects are related to the same data, to the same
formulas, …</p></li>
</ul>
<p>Implicitly assumed, the vector <code>tau</code> should be in strictly
increasing order.</p>
<p>Another <em>TList</em> class is the <code>"pgpTList"</code> class
which corresponds to a list of fitted Poisson-GP models. Mind that
consistently with <code>rq</code> and <code>fevd</code> a lower case
acronym is used, followed by <code>"TList</code>“. However, for now, the
class <code>"pgp"</code> does not exist. We can fit a
<code>pgpTList</code> object with a vector <code>tau</code> of length
one, if needed. A <code>pgpTList</code> object is quite similar to a
<code>fevdList</code> object. The main difference concerns the
exceedances and their occurrence in time: Instead of an assuming
constant rate <span class="math inline">\(\lambda\)</span>, a purely
temporal non-homogeneous Poisson process is used. A rate depending on
the time <span class="math inline">\(\lambda(t)\)</span> or on the time
and other covariates <span class="math inline">\(\lambda(\mathbf{x})\)</span> can be specified by
using a devoted formula for <span class="math inline">\(\log
\lambda\)</span>.</p>
<p><strong>Caution</strong> The development of <code>pgpTList</code>
class and of the relevant methods is far from being achieved. Some major
changes are likely to occur. For now the methods are as follows.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/methods.html" class="external-link">methods</a></span><span class="op">(</span>class <span class="op">=</span> <span class="st">"pgpTList"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1] exceed        logLik        makeNewData   modelMatrices parInfo      </span></span>
<span><span class="co">##  [6] predict       print         quantile      quantMax      residuals    </span></span>
<span><span class="co">## [11] simulate      summary      </span></span>
<span><span class="co">## see '?methods' for accessing help and source code</span></span></code></pre>
</div>
<div class="section level4">
<h4 id="some-important-remarks">Some important remarks<a class="anchor" aria-label="anchor" href="#some-important-remarks"></a>
</h4>
<ul>
<li><p>A <code>rq</code> object does not encode a full distribution nor
even a tail distribution. The <code>rq</code> objects may fail to be
consistent and the quantile may fail to increase with the probability
<span class="math inline">\(\tau\)</span>. See <span class="citation">(Northrop, Jonathan, and Randell 2016)</span>.</p></li>
<li><p>Strictly speaking, the <code>fevd</code> objects in a
<code>fevdTList</code> object are <em>different</em> Poisson-GP models,
although they must have the same formulas. Indeed, the Poisson-GP
parameterisation is not independent of the threshold: if the GPD scale
depends linearly of a covariate <span class="math inline">\(x\)</span>
for a given threshold <span class="math inline">\(u\)</span>, then for a
higher threshold <span class="math inline">\(u'&gt;u\)</span> the
scale will generally depend on <span class="math inline">\(x\)</span> in
a nonlinear fashion. See the relation between the two POT
parameterisation Poisson-GP and NHPP, only the later being independent
of the threshold.</p></li>
</ul>
</div>
</div>
<div class="section level3">
<h3 id="quantile-regression-for-seasonality">Quantile regression for seasonality<a class="anchor" aria-label="anchor" href="#quantile-regression-for-seasonality"></a>
</h3>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Rq</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rqTList.html">rqTList</a></span><span class="op">(</span>dailyMet <span class="op">=</span> <span class="va">Rennes</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/tau.html">tau</a></span><span class="op">(</span><span class="va">Rq</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## tau=0.50 tau=0.70 tau=0.80 tau=0.90 tau=0.95 tau=0.97 tau=0.98 tau=0.99 </span></span>
<span><span class="co">##     0.50     0.70     0.80     0.90     0.95     0.97     0.98     0.99</span></span></code></pre>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">formula</a></span><span class="op">(</span><span class="va">Rq</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## TX ~ Cst + cosj1 + sinj1 + cosj2 + sinj2 + cosj3 + sinj3 - 1</span></span>
<span><span class="co">## NULL</span></span></code></pre>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span><span class="va">Rq</span><span class="op">)</span></span></code></pre></div>
<p><img src="Intro_files/figure-html/rqTList0-1.png" width="768"></p>
<p>By default the creator <code>rqTList</code></p>
<ul>
<li><p>Uses some defined probabilities <span class="math inline">\(\tau\)</span> for the quantiles. These can be
assessed by the <code>tau</code> method.</p></li>
<li><p>Uses a <code>formula</code> which defines a yearly seasonality
for the quantiles. The default formula uses a basis of trigonometric
functions with 3 harmonics, corresponding the the fundamental frequency
<span class="math inline">\(1/365.25\:\text{day}^{-1}\)</span> and its
integer multiples <span class="math inline">\(2/365.25\)</span>, <span class="math inline">\(3/365.25\)</span>, …</p></li>
<li><p>Considers a “design” function which creates the required
variables <code>cosj1</code> , <code>sinj1</code>, <code>cosj2</code>,
<code>sinj2</code>, … where the integer after the prefix
<code>cos</code> of <code>sin</code> gives the frequency in increasing
order, standing for the fundamental frequency corresponding to the
one-year period.</p></li>
<li><p>Build the required variables from the existing variables in the
object specified by <code>dailyMet</code>, mainly from the
<code>Date</code> column.</p></li>
<li><p>Fits quantile regression <code>rq</code> objects from the
<strong>quantreg</strong> package</p></li>
</ul>
<p>More precisely the quantile <span class="math inline">\(q(\tau)\)</span> of the meteorological variable is
considered as a trigonometric polynomial function <span class="math inline">\(q_d(\tau)\)</span> of the day in the year <span class="math inline">\(d\)</span> (<span class="math inline">\(1
\leqslant d \leqslant 366\)</span>)</p>
<p><span class="math display">\[\begin{equation}
\tag{1}
q_d(\tau) \approx  \alpha_0^{q}(\tau) + \sum_{k=1}^K \alpha_k^{q}(\tau)
\cos\{2\pi k d/D\} +
    \beta_k^{q}(\tau) \sin\{2\pi k d/D\}
\end{equation}\]</span></p>
<p>where <span class="math inline">\(D:=365.25\)</span> is yearly period
expressed in days. The pseudo-exponent <span class="math inline">\(q\)</span> in the coefficients <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\beta\)</span> is used to recall that they
describe a quantile. The default number of harmonics <span class="math inline">\(K\)</span> is <span class="math inline">\(3\)</span>. The quantile regression provides the
estimated coefficients <span class="math inline">\(\hat{\alpha}_k^{q}(\tau)\)</span> and <span class="math inline">\(\hat{\beta}_k^{q}(\tau)\)</span>.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/methods.html" class="external-link">methods</a></span><span class="op">(</span>class <span class="op">=</span> <span class="st">"rqTList"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1] autolayer autoplot  coef      coSd      formula   predict   print    </span></span>
<span><span class="co">##  [8] summary   tau       xi       </span></span>
<span><span class="co">## see '?methods' for accessing help and source code</span></span></code></pre>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">Rq</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##               Cst     cosj1     sinj1       cosj2     sinj2       cosj3</span></span>
<span><span class="co">## tau=0.50 16.06393 -6.799077 -2.591552 -0.25845982 0.8639527 -0.03092440</span></span>
<span><span class="co">## tau=0.70 17.95239 -7.088085 -2.512324 -0.05437666 0.8490012  0.09359081</span></span>
<span><span class="co">## tau=0.80 19.16725 -7.533421 -2.492802 -0.04192276 0.8351121  0.17707189</span></span>
<span><span class="co">## tau=0.90 20.91793 -8.261868 -2.391511 -0.10477575 0.8021272  0.26742011</span></span>
<span><span class="co">## tau=0.95 22.24216 -8.813697 -2.265968 -0.24878473 0.8232536  0.24753280</span></span>
<span><span class="co">## tau=0.97 23.12972 -9.185094 -2.350450 -0.41137561 0.9621417  0.32897144</span></span>
<span><span class="co">## tau=0.98 23.81042 -9.465539 -2.349878 -0.47458855 1.0689253  0.25157101</span></span>
<span><span class="co">## tau=0.99 24.73573 -9.763231 -2.296899 -0.50022134 1.1528784  0.24505818</span></span>
<span><span class="co">##                sinj3</span></span>
<span><span class="co">## tau=0.50  0.06418181</span></span>
<span><span class="co">## tau=0.70  0.06247610</span></span>
<span><span class="co">## tau=0.80  0.04022597</span></span>
<span><span class="co">## tau=0.90 -0.05661638</span></span>
<span><span class="co">## tau=0.95 -0.09498655</span></span>
<span><span class="co">## tau=0.97 -0.17853494</span></span>
<span><span class="co">## tau=0.98 -0.26641707</span></span>
<span><span class="co">## tau=0.99 -0.27323854</span></span></code></pre>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/coSd.html">coSd</a></span><span class="op">(</span><span class="va">Rq</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##          Cst            cosj1          sinj1          cosj2         </span></span>
<span><span class="co">## tau=0.50 16.064 [0.027] -6.799 [0.042] -2.592 [0.034] -0.258 [0.037]</span></span>
<span><span class="co">## tau=0.70 17.952 [0.029] -7.088 [0.042] -2.512 [0.040] -0.054 [0.041]</span></span>
<span><span class="co">## tau=0.80 19.167 [0.035] -7.533 [0.052] -2.493 [0.047] -0.042 [0.049]</span></span>
<span><span class="co">## tau=0.90 20.918 [0.039] -8.262 [0.053] -2.392 [0.056] -0.105 [0.054]</span></span>
<span><span class="co">## tau=0.95 22.242 [0.048] -8.814 [0.066] -2.266 [0.069] -0.249 [0.067]</span></span>
<span><span class="co">## tau=0.97 23.130 [0.061] -9.185 [0.084] -2.350 [0.088] -0.411 [0.086]</span></span>
<span><span class="co">## tau=0.98 23.810 [0.065] -9.466 [0.086] -2.350 [0.098] -0.475 [0.090]</span></span>
<span><span class="co">## tau=0.99 24.736 [0.081] -9.763 [0.120] -2.297 [0.110] -0.500 [0.115]</span></span>
<span><span class="co">##          sinj2          cosj3          sinj3         </span></span>
<span><span class="co">## tau=0.50  0.864 [0.037] -0.031 [0.037]  0.064 [0.037]</span></span>
<span><span class="co">## tau=0.70  0.849 [0.041]  0.094 [0.040]  0.062 [0.040]</span></span>
<span><span class="co">## tau=0.80  0.835 [0.049]  0.177 [0.046]  0.040 [0.046]</span></span>
<span><span class="co">## tau=0.90  0.802 [0.054]  0.267 [0.051] -0.057 [0.051]</span></span>
<span><span class="co">## tau=0.95  0.823 [0.067]  0.248 [0.063] -0.095 [0.063]</span></span>
<span><span class="co">## tau=0.97  0.962 [0.085]  0.329 [0.080] -0.179 [0.080]</span></span>
<span><span class="co">## tau=0.98  1.069 [0.089]  0.252 [0.085] -0.266 [0.084]</span></span>
<span><span class="co">## tau=0.99  1.153 [0.115]  0.245 [0.108] -0.273 [0.108]</span></span></code></pre>
<p>The <code>coSd</code> method (for “coef” and “Standard error” or
“Standard deviation”) gives the coefficients and their standard error.
We see that some estimated coefficients are not significant, namely
those for the 3-rd harmonic for the “small” probabilities. However, when
<span class="math inline">\(\tau\)</span> becomes larger, the estimated
coefficients for the <span class="math inline">\(3\)</span>-rd harmonic
becomes significant, although their standard error increases because
they are based on a smaller number of observations. This suggests that
the <span class="math inline">\(3\)</span>-rd harmonic plays a role in
the seasonality of the extremes, although it will be difficult to
assess.</p>
<p>As may be guessed from the plot of quantiles, the fitted phases
corresponding to the different harmonics are quite similar across
probabilities <span class="math inline">\(\tau &lt; 0.95\)</span>. More
precisely we may consider the following alternative parameterisation of
the trigonometric polynomial</p>
<p><span class="math display">\[\begin{equation}
   \tag{2}
   q_d(\tau) \approx
    \gamma_0^{q}(\tau) + \sum_{k=1}^K
    \gamma_k^{q}(\tau) \sin\left\{2\pi k \left[d -
\phi_k^{q}(\tau)\right]/D\right\}
    
\end{equation}\]</span></p>
<p>where the parameter <span class="math inline">\(\gamma_k^{q}(\tau)\)</span> and <span class="math inline">\(\phi_k^{q}(\tau)\)</span> are called
<em>amplitudes</em> and <em>phase shifts</em> or simply <em>phases</em>.
The two formulations (1) and (2) are actually equivalent, as can be seen
from the trigonometric “angle subtraction formula” <span class="math inline">\(\sin(a -b) = \sin(a)\cos(b) - \cos(a)
\sin(b)\)</span>. We could think of using the second form in a
<code>quanteg::rq</code> fit, but this is not possible since the phase
<span class="math inline">\(\phi_k^q\)</span> appears in a nonlinear
fashion. So we can fit the linear cos-sin form and then compute the
estimate for the amplitudes and phases by using some trigonometry.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">co</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">Rq</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/phases.html">phases</a></span><span class="op">(</span><span class="va">co</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##          phi1  phi2  phi3 gamma1 gamma2 gamma3</span></span>
<span><span class="co">## tau=0.50  112  8.45   8.7   7.28  0.902 0.0712</span></span>
<span><span class="co">## tau=0.70  111  1.86 -19.0   7.52  0.851 0.1125</span></span>
<span><span class="co">## tau=0.80  110  1.46 -26.1   7.94  0.836 0.1816</span></span>
<span><span class="co">## tau=0.90  108  3.78  87.3   8.60  0.809 0.2733</span></span>
<span><span class="co">## tau=0.95  106  8.53  84.2   9.10  0.860 0.2651</span></span>
<span><span class="co">## tau=0.97  106 11.74  81.7   9.48  1.046 0.3743</span></span>
<span><span class="co">## tau=0.98  105 12.14  75.5   9.75  1.170 0.3664</span></span>
<span><span class="co">## tau=0.99  105 11.90  75.0  10.03  1.257 0.3670</span></span></code></pre>
<p>The table shows the <span class="math inline">\(K=3\)</span> phases
<span class="math inline">\(\phi_k\)</span> and amplitudes <span class="math inline">\(\gamma_k\)</span>. Note that the object returned
by <code>phases</code> has as special class <code>"phasesMatrix"</code>.
The amplitudes are actually stored as an attribute of the numeric matrix
of phases, not as a matrix with <span class="math inline">\(2K\)</span>
columns.</p>
<p>We see that for the different probabilities the phases of the <span class="math inline">\(1\)</span>-st and <span class="math inline">\(2\)</span>-nd harmonics are quite similar, while
those of the <span class="math inline">\(3\)</span>-rd harmonics are
different, and seem to drift as the probability <span class="math inline">\(\tau\)</span> increases.</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span><span class="fu"><a href="../reference/phases.html">phases</a></span><span class="op">(</span><span class="va">co</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="Intro_files/figure-html/rqTList3-1.png" width="768"></p>
<p>The constant <span class="math inline">\(\gamma_0^{[\tau]}\)</span>
does not appear on the plot.. Note that the amplitudes <span class="math inline">\(\gamma_k^{[\tau]}\)</span> rapidly decrease with
the frequency, consistently with the fact that the quantiles are quite
smooth functions of the day <span class="math inline">\(d\)</span>. The
amplitude slightly increases with <span class="math inline">\(\tau\)</span>, especially for the fundamental
frequency <span class="math inline">\(k=1\)</span>. In other words the
seasonality becomes more pronounced when the probability <span class="math inline">\(\tau\)</span> increases.</p>
</div>
<div class="section level3">
<h3 id="seasonality-in-time-varying-pot-models">Seasonality in (time-varying) POT models<a class="anchor" aria-label="anchor" href="#seasonality-in-time-varying-pot-models"></a>
</h3>
<div class="section level4">
<h4 id="why-seasonality-matters">Why seasonality matters<a class="anchor" aria-label="anchor" href="#why-seasonality-matters"></a>
</h4>
<p>Using a suitable description of the seasonality is a major concern in
POT modelling <span class="citation">(Coles and Tawn 2005)</span>, <span class="citation">(Coles 2004)</span>, <span class="citation">(Northrop,
Jonathan, and Randell 2016)</span>. Concerning our meteorological
variables, a natural idea is to use GP or GEV parameters depending on
the date through the day in year <span class="math inline">\(d\)</span>
since it is clear that the marginal distribution heavily depends on
<span class="math inline">\(d\)</span>.</p>
<p>There are also many reasons to use a seasonally time-varying
threshold <span class="math inline">\(u(d)\)</span> depending as well on
<span class="math inline">\(d\)</span>. One motivation is the efficiency
of the estimation: A constant threshold would be too low for a season
and too high for another. Moreover, if a constant threshold is used, the
results are likely to depend much on the threshold value because the
distribution over a period of several months in the year is actually a
weighted mixture of different distributions corresponding to the values
of <span class="math inline">\(d\)</span>, and their weight will depend
much on the constant threshold. For instance, if a constant threshold is
used for all the JJA period, the weight of the early June and late
August will be smaller when the threshold is increased.</p>
</div>
<div class="section level4">
<h4 id="seasonal-poisson-gp-models">Seasonal Poisson-GP models<a class="anchor" aria-label="anchor" href="#seasonal-poisson-gp-models"></a>
</h4>
<p>In order to describe the yearly seasonality, a natural idea is to use
a trigonometric polynomial as described above. For instance the GP scale
parameter <span class="math inline">\(\sigma\)</span> could depend on
<span class="math inline">\(t\)</span> though the day in year <span class="math inline">\(d\)</span> as in</p>
<p><span class="math display">\[
\sigma_d = \alpha_0^{\sigma} + \sum_{k=1}^K \alpha_k^{\sigma} \cos\{2\pi
k d/D\} +
    \beta_k^{\sigma} \sin\{2\pi k d/D\}
\]</span></p>
<p>where the coefficients <span class="math inline">\(\alpha_k^{\sigma}\)</span> and <span class="math inline">\(\beta_k^{\sigma}\)</span> are to be estimated.
However <span class="math inline">\(2 K +1\)</span> parameters and for
<span class="math inline">\(K=3\)</span> or even for <span class="math inline">\(K=2\)</span> the estimation can be difficult. To
facilitate the estimation, one can use instead the amplitude-phase
formulation</p>
<p><span class="math display">\[
   \sigma_d =
    \gamma_0^{\sigma} + \sum_{k=1}^K
    \gamma_k^{\sigma} \sin\left\{2\pi k \left[d - \phi_k
\right]/D\right\}
\]</span></p>
<p>where <em>the phases <span class="math inline">\(\phi_k\)</span> are
considered as fixed</em> or known. In practice, we can use the phases
<span class="math inline">\(\phi_k :=
{\hat{\phi}}^{q}_k(\tau_{\text{ref}})\)</span> given by quantile
regression for a fixed “reference” probability e.g., <span class="math inline">\(\tau_{\text{ref}} = 0.95\)</span>. So we have only
<span class="math inline">\(K+1\)</span> parameter to estimate. Since
the phases are usually quite stable for the high quantiles, hopefully
the same should be true also for the GP parameters.</p>
<p>The <code>"fevdTlist"</code> is a transitional class which requires
to “manually” create a list of <code>fevd</code> objects having the same
but different thresholds obtained by quantile regression. Once these
objects have been fitted and gathered in a list, the
<code>as.fevdTList</code> coercion method can be used. The
<code>"pgpTList"</code> class is easier to use.</p>
<p>Note that while using as above a large range of probability <span class="math inline">\(\tau\)</span> is adequate to get insights on the
variable, a narrower range of probability values seems more adequate for
POT models. We can use <span class="math inline">\(\tau\)</span>
ranging, say, from <span class="math inline">\(0.90\)</span> to <span class="math inline">\(0.98\)</span>.</p>
<p>To create a <code>pgpTList</code> object, the appropriate way is
<em>first, fit a <code>rqTList</code> object</em> with chosen
thresholds. This object will be passed to the <code>thresholds</code>
argument of the creator <code>pgpTList</code>. In order to compute the
sine wave basis functions with the prescribed phases corresponding to
the probability <span class="math inline">\(\tau_{\text{ref}}\)</span>,
the argument <code>tauRef</code> can be used.</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Rq</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rqTList.html">rqTList</a></span><span class="op">(</span>dailyMet <span class="op">=</span> <span class="va">Rennes</span>, tau <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.94</span>, <span class="fl">0.95</span>, <span class="fl">0.96</span>, <span class="fl">0.97</span>, <span class="fl">0.98</span>, <span class="fl">0.99</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">Pgp1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pgpTList.html">pgpTList</a></span><span class="op">(</span>dailyMet <span class="op">=</span> <span class="va">Rennes</span>, thresholds <span class="op">=</span> <span class="va">Rq</span>,</span>
<span>                declust <span class="op">=</span> <span class="cn">TRUE</span>, fitLambda <span class="op">=</span> <span class="cn">TRUE</span>, logLambda.fun <span class="op">=</span> <span class="op">~</span> <span class="va">YearNum</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">Pgp1</span>, lastFullYear <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span><span class="va">pred</span>, facet <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p><img src="Intro_files/figure-html/pgp-1.png" width="768"></p>
<p>The output of the code was not shown because the
<code><a href="https://rdrr.io/pkg/NHPoisson/man/fitPP.fun.html" class="external-link">NHPoisson::fitPP.fun</a></code> function used to fit the time part of
the model is very verbose. The Figure above shows the 100-year return
level (RL), which depends on the date, for the last full year of the
fitting period. We see that rather realistic values are obtained and
moreover that the fitted RL depends little on the threshold choice,
which is a nice feature. The default formulas used in the creator for
the GP part (hence passed to <code>fevd</code>) are</p>
<ul>
<li><p><code>scale.fun = ~Cst + sinjPhi1 + sinJPhi2 + sinjPhi3 - 1</code></p></li>
<li><p><code>shape.fun = ~1</code></p></li>
</ul>
<p>So no time-trend was specified in the GP part of the model. However a
time-trend was used for the exceedance rate, namely <span class="math display">\[
   \lambda(t) = \exp\{ \beta_0^\lambda + \beta_1^\lambda t \},
\]</span> where the time <span class="math inline">\(t\)</span> is given
by <code>YearNum</code> so the coefficient <span class="math inline">\(\beta^\lambda_1\)</span> is in inverse years <span class="math inline">\(\text{yr}^{-1}\)</span>.</p>
</div>
</div>
<div class="section level3">
<h3 id="how-pgptlist-works">How <code>pgpTList</code> works<a class="anchor" aria-label="anchor" href="#how-pgptlist-works"></a>
</h3>
<p>The value of <code>tauRef</code> is used to select the appropriate
line in the matrix <code>phases(coef(thresholds))</code> which is used
internally. So <code>tauRef</code> must correspond to a probability used
to define the thresholds. The so-created vector of phases
<code>phi</code> is then used to create the basis functions with the
<code>sinBasis</code> function or equivalently of the
<code>tsDesign</code> function with <code>type = "sinwave"</code>. The
sine wave basis functions are used to add new variables to the data
frame given in <code>dailyMet</code>. Then the “fitting functions”
<code><a href="https://rdrr.io/pkg/extRemes/man/fevd.html" class="external-link">extRemes::fevd</a></code> and <code>NHPoisson:fitPP.fun</code> are
used to fit the “GP” part” and the (temporal) “Poisson part” for each of
the thresholds computed from the <code>thresholds</code> object. The
results for the “GP” part and the the time Poisson part are stored as
the two elements <code>"GP"</code> and <code>"timePoisson"</code> of the
returned list, the first having the class <code>"fevdTList"</code>. We
hence can use the methods for the <code>"fevdTList"</code> class to get
insights on the <code>"GP"</code> part of our <code>pgpTList</code>
object.</p>
<p><strong>Caution</strong> The log-likelihood of a Poisson-GP is the
sum of two contributions corresponding to the GP and the time-Poisson
parts, see Northrop et Al.</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Phi</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/phases.html">phases</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">Rq</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="investigating-the-distribution-of-the-maximum">Investigating the distribution of the maximum<a class="anchor" aria-label="anchor" href="#investigating-the-distribution-of-the-maximum"></a>
</h3>
<div class="section level4">
<h4 id="goal">Goal<a class="anchor" aria-label="anchor" href="#goal"></a>
</h4>
<p>One often wants to investigate the distribution of the maximum <span class="math inline">\(M := \max_t y_t\)</span> where the maximum is
taken on a “new” period of interest, typically a period in the near
future. By using a Poisson-GP POT model one can only investigate the
<em>tail-distribution</em> of <span class="math inline">\(M\)</span>.
More precisely the Poisson-GP model allows the computation of <span class="math inline">\(\text{Pr}\{M \leqslant m\}\)</span> when <span class="math inline">\(m\)</span> is larger than the maximum of the
thresholds on the period of interest <span class="math inline">\(m&gt;
\max_t u(t)\)</span>. The reason is that when this condition holds the
condition <span class="math inline">\(M &gt; m\)</span> is equivalent to
<span class="math inline">\(M_{\texttt{peak}} &gt; m\)</span> where
<span class="math inline">\(M_{\texttt{peak}}\)</span> denotes the
maximum of the peaks on the same period.</p>
<p>One can show that <span class="math display">\[
   \log \text{Pr}\{M \leqslant m \} = -\int \lambda_u(t) \,
    S_{\texttt{GP2}}\{m - u(t);\, \sigma_u(t), \, \xi(t)\}\,
        \text{d}t, \qquad \text{for } m \text{ large},
\]</span> where the time integral is on the period of interest, and the
discrete-time approximation is <span class="math display">\[
  \log \Pr\{ M \leqslant m \}
      \approx - \frac{1}{365.25} \, \sum_t
      \lambda_{u,t} \, S_{\texttt{GP2}}(m - u_t;\, \sigma_t,\, \xi_t),
      \qquad \text{for } m \text{ large}.
\]</span></p>
<p>In both cases the condition <span class="math inline">\(m \text{
large}\)</span> is more precisely <span class="math inline">\(m &gt;
\max_t u(t)\)</span> or <span class="math inline">\(m&gt; \max_t
u_t\)</span>.</p>
<p>Note that <span class="math inline">\(M\)</span> does <em>not</em>
follow a Generalized Extreme Value (GEV) distribution, even in its tail,
but has the same tail as a mixture of GEV distributions. In particular
if the shape <span class="math inline">\(\xi_t\)</span> is chosen to be
time-varying then the largest values of <span class="math inline">\(\xi_t\)</span> will have a disproportionate impact
on the high quantiles.</p>
</div>
<div class="section level4">
<h4 id="using-the-quantile-method">Using the <code>quantile</code> method<a class="anchor" aria-label="anchor" href="#using-the-quantile-method"></a>
</h4>
<p>The <code>quantile</code> method can be used to compute the tail
quantiles from a <code>pgpTList</code> object</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Date</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2020-01-01"</span><span class="op">)</span>,</span>
<span>            to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2050-01-01"</span><span class="op">)</span>, by <span class="op">=</span> <span class="st">"day"</span><span class="op">)</span></span>
<span><span class="va">qMax</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/NSGEV/man/quantMax.html" class="external-link">quantMax</a></span><span class="op">(</span><span class="va">Pgp1</span>, newdata <span class="op">=</span> <span class="va">Date</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span><span class="va">qMax</span><span class="op">)</span></span></code></pre></div>
<p><img src="Intro_files/figure-html/pgpQuant-1.png" width="100%"></p>
<p>We can display the quantiles in a table</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">qMax</span><span class="op">)</span>, <span class="va">tau</span> <span class="op">==</span> <span class="fl">0.96</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left"></th>
<th align="left">tau</th>
<th align="right">Prob</th>
<th align="right">ProbExc</th>
<th align="right">Quant</th>
<th align="right">L</th>
<th align="right">U</th>
<th align="right">Level</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">93</td>
<td align="left">0.96</td>
<td align="right">0.950</td>
<td align="right">0.050</td>
<td align="right">41.32</td>
<td align="right">40.08</td>
<td align="right">42.57</td>
<td align="right">0.95</td>
</tr>
<tr class="even">
<td align="left">97</td>
<td align="left">0.96</td>
<td align="right">0.980</td>
<td align="right">0.020</td>
<td align="right">41.76</td>
<td align="right">40.39</td>
<td align="right">43.14</td>
<td align="right">0.95</td>
</tr>
<tr class="odd">
<td align="left">99</td>
<td align="left">0.96</td>
<td align="right">0.990</td>
<td align="right">0.010</td>
<td align="right">42.04</td>
<td align="right">40.57</td>
<td align="right">43.50</td>
<td align="right">0.95</td>
</tr>
<tr class="even">
<td align="left">102</td>
<td align="left">0.96</td>
<td align="right">0.995</td>
<td align="right">0.005</td>
<td align="right">42.27</td>
<td align="right">40.72</td>
<td align="right">43.82</td>
<td align="right">0.95</td>
</tr>
<tr class="odd">
<td align="left">103</td>
<td align="left">0.96</td>
<td align="right">0.995</td>
<td align="right">0.005</td>
<td align="right">42.27</td>
<td align="right">40.72</td>
<td align="right">43.82</td>
<td align="right">0.95</td>
</tr>
<tr class="even">
<td align="left">106</td>
<td align="left">0.96</td>
<td align="right">0.998</td>
<td align="right">0.002</td>
<td align="right">42.53</td>
<td align="right">40.87</td>
<td align="right">44.18</td>
<td align="right">0.95</td>
</tr>
<tr class="odd">
<td align="left">107</td>
<td align="left">0.96</td>
<td align="right">0.999</td>
<td align="right">0.001</td>
<td align="right">42.67</td>
<td align="right">40.95</td>
<td align="right">44.40</td>
<td align="right">0.95</td>
</tr>
</tbody>
</table>
<p>Note that the class <code>"pgpTList"</code> has a <code>format</code>
method used here. This method rounds the quantiles and confidence limit
<code>digits</code> but it also selects “round” exceedance probabilities
such as <code>0.1</code>, <code>0.01</code> as is often needed in
reports. To save space, only the quantiles corresponding to one value of
<span class="math inline">\(\tau\)</span> are shown here.</p>
</div>
<div class="section level4">
<h4 id="using-the-simulate-method">Using the <code>simulate</code> method<a class="anchor" aria-label="anchor" href="#using-the-simulate-method"></a>
</h4>
<p>As an alternative we can simulate the (declustered) exceedances on
the period of interest. By default only the large exceedances will be
simulated. More precisely, for each value of <span class="math inline">\(\tau\)</span> a new threshold <span class="math inline">\(v := \max_{t} u(t)\)</span> is defined and only
the exceedances over <span class="math inline">\(v\)</span> will be
considered. These events occur in summer.</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/simulate.html" class="external-link">simulate</a></span><span class="op">(</span><span class="va">Pgp1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span><span class="va">sim</span><span class="op">)</span></span></code></pre></div>
<p><img src="Intro_files/figure-html/pgpSim-1.png" width="100%"></p>
<p>By default, only one simulation is done. But by using the formal
argument <code>nsim</code> with a large value (say
<code>nsim = 1000</code> or more) we can compute estimate quantiles, see
the help <code>?simulate.PgpTList</code>. For each simulation <span class="math inline">\(k=1\)</span>, <span class="math inline">\(\dots\)</span>, <span class="math inline">\(K\)</span> where <span class="math inline">\(K\)</span> is given by <code>nsim</code>, the
<code>simulate</code> method provides the random exceedance times <span class="math inline">\(T_i^{[k]}\)</span> and the related random marks
<span class="math inline">\(Y_i^{[k]}\)</span> for <span class="math inline">\(i=1\)</span>, <span class="math inline">\(\dots\)</span>, <span class="math inline">\(N^{[k]}\)</span> where <span class="math inline">\(N^{[k]}\)</span> is random and varies across
simulations. We then have a sample of <span class="math inline">\(K\)</span> maxima <span class="math inline">\(M^{[k]} := \max_i Y_i^{[k]}\)</span> and the
sample quantiles of the <span class="math inline">\(M^{[k]}\)</span>
should be close to those given by the <code>quantile</code> method.</p>
<p>Mind that a large value of <span class="math inline">\(K\)</span>
used must be chosen large to estimate the quantiles and that the
<code>simulate</code> method can be quite slow. Also some warnings are
likely to be thrown related to rounding the exceedance times. The
explanation is that the simulation of the exceedance times <span class="math inline">\(T_i\)</span> is based on a continuous-time Poisson
Process, so that some rounding is needed to get dates and this can lead
“ex-aequo” that must be discarded.</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="appendix">Appendix<a class="anchor" aria-label="anchor" href="#appendix"></a>
</h2>
<div class="section level3">
<h3 id="technical-issues">Technical issues<a class="anchor" aria-label="anchor" href="#technical-issues"></a>
</h3>
<div class="section level4">
<h4 id="related-to-quantreg">Related to <strong>quantreg</strong><a class="anchor" aria-label="anchor" href="#related-to-quantreg"></a>
</h4>
<ul>
<li><p>An <code>rq</code> object as created by <code><a href="https://rdrr.io/pkg/quantreg/man/rq.html" class="external-link">quantreg::rq</a></code>
does not store the data used.</p></li>
<li><p>Coping with missing value <code>NA</code> is difficult because
the default prediction corresponds to <code>na.omit</code> which removes
the observations with <code>NA</code> response.</p></li>
</ul>
</div>
<div class="section level4">
<h4 id="related-to-extremes">Related to <strong>extRemes</strong><a class="anchor" aria-label="anchor" href="#related-to-extremes"></a>
</h4>
<ul>
<li><p>An object with class <code>"fevd"</code> corresponding to a
Poisson-GP POT model does not fit the “time part” of the process. There
is usually no reason to assume that the exceedance rate is
constant.</p></li>
<li><p>An object with class <code>"fevd"</code> corresponding to a
Poisson-GP POT model does not store the value of the threshold as
required to make a prediction on a new data. Consequently the
<code>predict</code> method for the <code>"fevd"</code> class as
implemented in <strong>dailymet</strong> is unreliable because an
attempt is made to find the threshold from the stored <code>call</code>,
but the corresponding objects are most often not found.</p></li>
</ul>
</div>
<div class="section level4">
<h4 id="related-to-nhpoisson">Related to <strong>NHPoisson</strong><a class="anchor" aria-label="anchor" href="#related-to-nhpoisson"></a>
</h4>
<ul>
<li><p>There is no formula interface for <code>fitPP.fun</code>. The
covariates are given in a numeric matrix. The coefficients do not have
appealing names and the order of the columns in the matrix of covariates
matters.</p></li>
<li><p>The class <code>"mlePP"</code> corresponding to the objects
created by <code>fitPP.mle</code> does not have a <code>predict</code>
method.</p></li>
</ul>
</div>
</div>
</div>
<div class="section level2">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-ColesTawn_UsesMisuses" class="csl-entry">
Coles, Stuart. 2004. <span>“<span class="nocase">The Use and Misuse of
Extreme Value Models in Practice</span>.”</span> In <em><span class="nocase">Extreme Values in Finance, Telecommunications, and the
Environment</span></em>, edited by Bärbel Finkenstädt and Holger
Rootzén. Chapman &amp; Hall.
</div>
<div id="ref-ColesTawn_SeasonalSurges" class="csl-entry">
Coles, Stuart, and Jonathan Tawn. 2005. <span>“<span class="nocase">Seasonal Effects of Extreme Surges</span>.”</span>
<em>Stochastic Environmental Research and Risk Assessment</em> 19 (6):
417–27. <a href="https://doi.org/10.1007/s00477-005-0008-3" class="external-link">https://doi.org/10.1007/s00477-005-0008-3</a>.
</div>
<div id="ref-NorthropEtAl_NSExtremes" class="csl-entry">
Northrop, Paul J., Philip Jonathan, and David Randell. 2016.
<span>“<span class="nocase">Threshold Modelling of Non-Stationary
Extremes</span>.”</span> In <em><span class="nocase">Extreme Value
Modeling and Risk Analysis</span></em>, edited by D. K. Dey and J. Yan.
<span>Chapman &amp; Hall</span>.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Yves Deville.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
